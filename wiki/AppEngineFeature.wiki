#labels BotPlatform,AppEngine,NewFeature
= AppEngine Feature (New) =

In this page, we will introduce a new feature to you which named 'AppEngine'.

As you may not have your own server which allows you to connect to our platform directly by using our SDK, now there is another way to go, what you need is just a host on which your programs are deployed, and specify the URL in the admin page.(Use your SPID and password and sign in on http://botplatform.com, you will see this option in 'Basic Information ').

Note: If your SDK program already connects while you also provide the service for AppEngine, SDK is preferred.

= Details =

When you get ready for this, we will transer XML data through HTTP POST to the specified URL and get the HTTP response (also in XML format) to perform actions.

*We will post almost all of the 'Session Level' messages between your bot and your users to the specified URL. The XML's structure is clear and easy to understand (You may compare it with its corresponding Class file we difined in SDK), the 'type' element indicates the kind of the current message. *

_Examples of our XML data for POST:_
  * TestMessage : 
{{{
<response>
  <robotId>bot@hotmail.com</robotId>
  <userId>abc@hotmail.com</userId>
  <sessionId>5257573032606033981</sessionId>
  <type>msg</type>
  <msg>
    <fontStyle>0</fontStyle>
    <fontName>宋体</fontName>
    <fontColor>0</fontColor>
    <text>some plain text</text>
  </msg>
</response>
}}}

  * Typing Message :
{{{
<response>
  <robotId>bot@hotmail.com</robotId>
  <userId>abc@hotmail.com</userId>
  <sessionId>5257573032606033981</sessionId>
  <type>typing</type>
</response>
}}}

  * Wink Message :
{{{
<response>
  <robotId>bot@hotmail.com</robotId>
  <userId>abc@hotmail.com</userId>
  <sessionId>5257573032606033981</sessionId>
  <type>winkevent</type>
  <winkevent>
    <digest>Wink digest</digest>
    <name>Wink Name</name>
    <size>30900</size>
  </winkevent>
</response>
}}}

  * Ink Message :
{{{
<response>
  <robotId>bot@hotmail.com</robotId>
  <userId>abc@hotmail.com</userId>
  <sessionId>5257573032606033981</sessionId>
  <type>inkmsg</type>
  <inkmsg>ink data</inkmsg>
</response>
}}}

  * Application Window Message :
{{{
<response>
  <robotId>bot@hotmail.com</robotId>
  <userId>abc@hotmail.com</userId>
  <sessionId>5257573032606033981</sessionId>
  <type>appevent</type>
  <appevent>accept</appevent><!-- user accepts the activity window invite. -->
</response>

<response>
  <robotId>bot@hotmail.com</robotId>
  <userId>abc@hotmail.com</userId>
  <sessionId>5257573032606033981</sessionId>
  <type>appevent</type>
  <appevent>ready</appevent><!-- the activity window loaded -->
</response>
}}}


*When posted, we expect the HTTP response. You may perform several actions per message(a HTTP request) if you obey the XML definition shown blow. *


_Definition of the XML structure in HTTP response:_
{{{
<actions>
	<action type="nudge" /><!-- send nudge -->
	<action type="typing" /><!-- send typing -->
	<action type="msg"><!-- send text message -->
		<fontColor>CCCCCC</fontColor>
		<fontStyle>10</fontStyle>
		<fontName>Tahoma</fontName>
		<text>hello(1) world(2)</text>
		<emoticons>
			<entry key="(1)" value="emo1.png" />
			<entry key="(2)" value="emo2.png" />
		</emoticons>
	</action>
	<action type="wink"><!-- send specified wink -->
		<name>wink.cab</name>
		<stamp>stamp of the wink, can be empty</stamp>
	</action>
	<action type="ink"><!-- send ink message -->
		<data>base64 encoded ink data</data>
	</action>
	<action type="voice"><!-- send specified voiceclip -->
		<name>voiceclip.wav</name>
	</action>
	<action type="filecmd"><!-- when a user sends a file to your bot -->
		<cmd>accept</cmd><!-- accept or reject -->
		<transferId>tid</transferId>
		<saveUrl>http://example.saveurl.com</saveUrl><!-- for accept command only -->
	</action>
	<action type="file"><!-- send a specified file to your users -->
		<name>file.pdf</name>
	</action>
	<action type="app"><!-- open activity window -->
		<name>BotPlatform</name>
		<data>http://botplatform.com</data>
	</action>
</actions>
}}}

_Sample code (A simple Java Servlet for AppEngine service) :
{{{
try {
	ServletInputStream is = this.request.getInputStream();
	byte[] buf = new byte[1024];
	int i = 0;
	ByteArrayOutputStream bos = new ByteArrayOutputStream();
	while ((i = is.read(buf)) != -1) {
		bos.write(buf, 0, i);
	}
	is.close();
	bos.close();
	String xml = new String(bos.toByteArray(), "UTF-8");
	Pattern p = Pattern.compile(".*<type>(.*)</type>.*");
	Matcher matcher = p.matcher(xml);
	String type = null;
	while (matcher.find()) {
		type = matcher.group(1);
	}
	String response = null;
	if ("typing".equals(type)) {
		// TODO
	} else if ("nudge".equals(type)) {
		response = "<actions><action type=\"nudge\" /></actions>";
	} else if ("fileevent".equals(type)) {
		if (xml.indexOf("<event>invite</event>") > 0) {
			Random ran = new Random();
			p = Pattern.compile(".*<transferId>(.*)</transferId>.*");
			Matcher mat2 = p.matcher(xml);
			String tid = null;
			while (mat2.find()) {
				tid = mat2.group(1);
			}
			int ranInt = ran.nextInt(2);
			if (0 == ranInt) {
				response = "<actions><action type=\"filecmd\"><cmd>accept</cmd><transferId>"
								+ tid + "</transferId></action></actions>";
			} else if (1 == ranInt) {
				response = "<actions><action type=\"filecmd\"><cmd>reject</cmd><transferId>"
								+ tid + "</transferId></action></actions>";
					}
		}
	} else if ("winkevent".equals(type)) {
		response = "<actions><action type=\"wink\"><name>wink.dat</name><stamp>omitted here</stamp></action></actions>";
	} else if ("inkmsg".equals(type)) {
		response = "<actions><action type=\"ink\"><data>omitted here</data></action></actions>";
	} else if ("msg".equals(type)) {
		p = Pattern.compile(".*<text>(.*)</text>.*");
		Matcher mat3 = p.matcher(xml);
		String content = null;
		while (mat3.find()) {
			content = mat3.group(1);
		}
		if ("voice".equals(content))
			response = "<actions><action type=\"voice\"><name>voiceclip.wav</name></action></actions>";
		else if ("app".equals(content))
			response = "<actions><action type=\"app\"><name>BotPlatform</name><data>http://botplatform.com</data></action></actions>";
		else if ("file".equals(content))
			response = "<actions><action type=\"file\"><name>demo.txt</name></action></actions>";
		else if ("typing".equals(content))
			response = "<actions><action type=\"typing\" /></actions>";
		else
			response = "<actions><action type=\"msg\"><fontColor>CCCCCC</fontColor><fontStyle>10</fontStyle><fontName>Tahoma</fontName>" + 
		"<text>hello(1)world(2)</text><emoticons><entry key=\"(1)\" value=\"emo1.png\" /><entry key=\"(2)\" value=\"emo2.png\" /></emoticons></action></actions>";
	}
	if (response != null)
		writeResponse(response);//output
} catch (IOException e) {
	e.printStackTrace();
}
}}}